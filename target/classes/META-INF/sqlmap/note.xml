<?xml version="1.0" encoding="UTF-8"?>
<!-- 
@Project : copyNpaste
@File name : note.xml 
@Date : 2018.10.06 
@Author : 우나연 
@Desc 	: note dao 매퍼 쿼리문 작성. -->		

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="tk.copyNpaste.mapper.NoteMapper">

	<!--주제별 상위노트 목록 보기 -->
	<select id="selectTopNote" resultType="NoteVO">
	select n.noteNum, n.folderName, n.userEmail, n.noteTitle, n.noteContent, n.noteDate,
	n.subjectCode, n.noteCount, n.notePublic, n.notescrap, n.notePNum, u.userNick
	from note n join users u on u.userEmail=n.userEmail 
				join subject s on s.subjectCode=n.subjectCode 
	where s.subjectName = #{subjectName}		
	order by n.noteCount desc , n.noteDate desc limit 4;
	</select>

	<!--회원의 MY노트 목록 보기 -->
	<select id="selectAllNote" resultType="NoteVO">
	select n.noteNum, n.folderName, n.userEmail, n.noteTitle, n.noteContent, n.noteDate,
	n.subjectCode, n.noteCount, n.notePublic, n.notescrap, n.notePNum, u.userNick
	from note n join users u on u.userEmail=n.userEmail where u.userEmail = #{userEmail} order by noteNum desc;
	<!-- select distinct n.noteNum, n.folderName, n.userEmail, n.noteTitle, n.noteContent, n.noteDate,
	n.subjectCode, n.noteCount, n.notePublic, n.notescrap, n.notePNum, n.noteThumnail, u.userNick
	from note n join users u on u.userEmail=n.userEmail
	join folder f on f.folderName=n.folderName where u.userEmail = #{userEmail} and f.folderName= #{folderName} order by noteNum desc; -->
	</select>
	
	<!-- 노트 상세 보기(+노트 작성) -->
	<select id="selectDetailNote" resultType="NoteVO">
	select n.noteNum, n.folderName, n.userEmail, n.noteTitle, n.noteContent, n.noteDate,
	n.subjectCode, n.noteCount, n.notePublic, n.notescrap, n.notePNum, u.userNick
	from note n join users u on u.userEmail=n.userEmail where noteNum = #{noteNum};
	</select>

	<!-- 노트 댓글 보기 -->
	<select id="selectAllNoteComm" resultType="NoteCommVO">
	select nc.noteCommNum, nc.userEmail, nc.noteNum, nc.commDept, nc.commContent, nc.commDate, nc.noteCommPNum, u.userNick
	from notecomm nc join users u on u.userEmail=nc.userEmail where noteNum = #{nc.noteNum};
	</select>
	
	<!-- 노트 댓글 작성 -->
 	<insert id="insertNoteComm">
        <selectKey order="BEFORE" keyProperty="noteCommNum" resultType="int">
        select max(noteCommNum)+1 from notecomm
        </selectKey>
        insert into notecomm(noteCommNum, userEmail, noteNum, commContent)
        values(#{noteCommNum}, #{userEmail}, #{noteNum}, #{commContent})
    </insert>
    
	<!-- 노트 댓글 삭제 -->
	<!-- useGeneratedKeys="true" keyProperty="dragNo" (as id붙여서) 셀렉트키 사용시 필요-->
	<!-- 노트 등록 -->
	 <insert id="insertNote">
        <selectKey order="BEFORE" keyProperty="noteNum" resultType="int">
            select max(noteNum)+1 from note
        </selectKey>
        insert into note(noteNum, folderName, userEmail, noteTitle, noteContent, subjectCode, notePublic)
        values(#{noteNum}, #{folderName}, #{userEmail}, #{noteTitle}, #{noteContent}, #{subjectCode}, #{notePublic})
    </insert>
    
    <!-- 노트 주제 조회 -->
    <select id="selectSubjectCode" resultType="NoteVO">
	select subjectCode, subjectName from subject
	</select>

	<!-- 노트 수정 -->
	<update id="updateNote">
	 	<!-- <selectKey order="BEFORE" keyProperty="subjectName" resultType="String">
        select subjectCode from subject where subjectName = #{subjectName}
        </selectKey> -->
		 update note 
			SET noteTitle=#{noteTitle},
				noteContent=#{noteContent}, 
				folderName=#{folderName},
				subjectCode=#{subjectCode}
		WHERE noteNum=#{noteNum}
	</update>
	
	<!-- 노트 삭제 -->
	<delete id="deleteNote">
		DELETE FROM note WHERE noteNum = #{noteNum}
	</delete>
	
	<!--노트 폴더별 조회 -->
	<select id="selectByFolderNote" resultType="NoteVO">
	select n.noteNum, n.folderName, n.userEmail, n.noteTitle, n.noteContent, n.noteDate,
	n.subjectCode, n.noteCount, n.notePublic, n.notescrap, n.notePNum, n.noteThumnail, u.userNick
	from note n join users u on u.userEmail=n.userEmail 
	where u.userEmail = #{userEmail} and n.folderName =#{folderName}
	order by noteNum desc;
	</select>
	
	<!-- 노트 정렬 -->
	<select id="selectOrderbyNote" resultType="NoteVO">
	select n.noteNum, n.folderName, n.userEmail, n.noteTitle, n.noteContent, n.noteDate,
	n.subjectCode, n.noteCount, n.notePublic, n.notescrap, n.notePNum, n.noteThumnail, u.userNick
	from note n join users u on u.userEmail=n.userEmail 
	where u.userEmail = #{userEmail} order by #{sortCategory} 
	</select>
	
	<!-- 노트 달력 검색 -->
	
	<!-- my노트 키워드 검색 -->
	<select id="selectByKeyNote"  parameterType="hashmap" resultType="NoteVO">
  	select n.noteNum, n.folderName, n.userEmail, n.noteTitle, n.noteContent, n.noteDate,
	n.subjectCode,s.subjectName, n.noteCount, n.notePublic, n.notescrap, n.notePNum, n.noteThumnail, u.userNick
	from note n join users u on u.userEmail=n.userEmail 
				join subject s on s.subjectCode=n.subjectCode 
	where n.userEmail = #{userEmail} and 
		 (n.noteTitle like CONCAT('%',#{keyword},'%') or 
		  n.noteContent like CONCAT('%',#{keyword},'%') or 
		  n.folderName like CONCAT('%',#{keyword},'%') or 
		  s.subjectName like CONCAT('%',#{keyword},'%'))
	order by noteNum desc;
	</select>
	<!-- 회원별 노트 검색 -->
	
	
	<!-- 회원별 노트 일괄 삭제 -->
	
	<!-- 스크랩노트 등록 -->
	
	<!-- 스크랩노트 삭제 -->

	<!-- 노트 정렬 -->
	
	<!-- 노트 블라인드 처리 -->
	
	<!-- 노트의 폴더 이동 -->
	
	
	
	<!-- 	
	//NoteVO
	//노트
	//노트번호,폴더명,회원이메일,노트제목,노트내용,작성일,주제코드,참조카운트,
	//글공개여부,스크랩,부모노트번호,신고카운트
	private int noteNum;
	private String folderName;
	private String userEmail;
	private String noteTitle;
	private String noteContent;	
	private Date noteDate;
	private String subjectCode;
	private int noteCount;
	private int notePublic;
	private int noteScrap;
	private int notePNum;
	private int noteCheck;
	
	//NoteCommVO
	//노트 댓글
	//회원이메일,댓글번호,부모댓글번호,댓글작성일,댓글내용,댓글깊이,노트번호,
	private int noteCommNum;
	private String userEmail;
	private int noteNum;
	private int commDept;
	private int commContent;
	private Date commDate;
	private int noteCommPNum;
	-->
	
<!--     update note n
  	join subject s on s.subjectCode = n.subjectCode
  	set m.ever_seq_no = s.ever_seq_no; -->
 <!-- 	 <foreach collection="subjectNames" item="subject"  open="(" close=")" separator=",">
               </foreach>  -->   
</mapper>













